<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pencarian di GitHub Repo</title>
</head>
<body>
  <pre id="result">Memuat hasil...</pre>
  <script>
    window.onload = async function () {
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get("token");
      const searchWord = urlParams.get("q");
      const owner = "Madani93";
      const repo = "sru1";
      const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/`;

      if (!token || !searchWord) {
        document.getElementById("result").textContent =
          "Token dan kata pencarian (q) harus ada di URL sebagai query parameter.";
        return;
      }

      const result = [];

      try {
        const response = await fetch(apiUrl, {
          headers: {
            Authorization: `token ${token}`,
            Accept: "application/vnd.github.v3+json",
          },
        });

        if (!response.ok) {
          throw new Error("Gagal mengambil data dari GitHub. Status: " + response.status);
        }

        const files = await response.json();

        for (const file of files) {
          // Lewati file yang tidak berbentuk JSON, seperti 'index'
          if (file.name === "index" || !file.name.endsWith(".json")) {
            continue;
          }

          const fileResponse = await fetch(file.download_url);
          const fileText = await fileResponse.text(); // Ambil konten file sebagai teks

          try {
            const fileContent = JSON.parse(fileText); // Parse teks ke JSON

            // Mencari kata pencarian dalam konten JSON
            const searchResult = searchInJson(fileContent, searchWord);

            if (searchResult.length > 0) {
              result.push({
                file: file.name,
                found: searchResult,
              });
            }
          } catch (error) {
            console.warn(`File ${file.name} bukan JSON valid:`, error.message);
          }
        }

        const resultContainer = document.getElementById("result");
        if (result.length > 0) {
          resultContainer.textContent = JSON.stringify(result, null, 2);
        } else {
          resultContainer.textContent = `Tidak ditemukan hasil untuk pencarian: "${searchWord}"`;
        }
      } catch (error) {
        console.error("Error:", error);
        document.getElementById("result").textContent =
          "Terjadi kesalahan saat mencari: " + error.message;
      }
    };

    function searchInJson(obj, searchWord) {
      let results = [];

      if (typeof obj === "object") {
        for (let key in obj) {
          if (obj.hasOwnProperty(key)) {
            const value = obj[key];

            if (typeof value === "object") {
              const nestedResults = searchInJson(value, searchWord);
              if (nestedResults.length > 0) {
                results.push(...nestedResults);
              }
            } else if (
              typeof value === "string" &&
              value.toLowerCase().includes(searchWord.toLowerCase())
            ) {
              results.push({ [key]: value });
            }
          }
        }
      }

      return results;
    }
  </script>
</body>
</html>
