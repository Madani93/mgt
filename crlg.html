<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cari Kata di Repository GitHub</title>
  <script>
    window.onload = async function() {
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token'); // Mengambil token dari URL
      const searchWord = urlParams.get('q'); // Mengambil kata pencarian dari URL (diganti menjadi 'q')
      const owner = 'Madani93'; // Owner repository sru1
      const repo = 'sru1'; // Nama repository sru1
      const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/`;

      // Jika token atau kata pencarian tidak ada di URL, tampilkan peringatan
      if (!token || !searchWord) {
        alert('Token dan kata pencarian (q) harus ada di URL sebagai query parameter.');
        return;
      }

      const result = [];

      try {
        // Mengambil daftar file dari repositori GitHub
        const response = await fetch(apiUrl, {
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });

        if (!response.ok) {
          throw new Error('Gagal mengambil data dari GitHub. Status: ' + response.status);
        }

        const files = await response.json();

        // Memeriksa setiap file di dalam repositori
        for (const file of files) {
          if (file.type === 'file' && file.name !== 'index') { // Menghindari file 'index'
            const fileResponse = await fetch(file.download_url);
            const fileContent = await fileResponse.json(); // Mengambil dan memparsing konten JSON file
          
            // Mencari kata pencarian dalam konten JSON file
            const searchResult = searchInJson(fileContent, searchWord);

            if (searchResult) {
              // Jika ditemukan, simpan hasilnya
              result.push({
                file: file.path,
                found: searchResult
              });
            }
          }
        }

        // Menampilkan hasil pencarian langsung di halaman
        const resultContainer = document.getElementById('result');
        if (result.length > 0) {
          resultContainer.innerHTML = JSON.stringify(result, null, 2); // Menampilkan hasil dalam format JSON
        } else {
          resultContainer.textContent = `Tidak ditemukan hasil untuk pencarian: "${searchWord}"`;
        }

      } catch (error) {
        console.error('Error:', error);
        alert('Terjadi kesalahan saat mencari: ' + error.message);
      }
    }

    // Fungsi untuk mencari kata dalam array objek JSON
    function searchInJson(arr, searchWord) {
      let result = [];

      // Periksa apakah arr adalah array
      if (Array.isArray(arr)) {
        for (let i = 0; i < arr.length; i++) {
          const obj = arr[i];

          // Cari kata dalam setiap kolom (key) di objek
          const searchResult = searchInObject(obj, searchWord);

          if (searchResult) {
            result.push({ [i]: searchResult }); // Simpan hasil sesuai indeks objek dalam array
          }
        }
      }

      return result.length > 0 ? result : null;
    }

    // Fungsi untuk mencari kata dalam objek
    function searchInObject(obj, searchWord) {
      let result = [];

      if (typeof obj === 'object') {
        for (let key in obj) {
          if (obj.hasOwnProperty(key)) {
            const value = obj[key];
            if (typeof value === 'string' && value.includes(searchWord)) {
              // Jika kata pencarian ditemukan, simpan objek terkait
              result.push({ [key]: value });
            }
          }
        }
      }

      return result.length > 0 ? result : null;
    }
  </script>
</head>
<body>
  <h2>Hasil Pencarian:</h2>
  <pre id="result"></pre>
</body>
</html>
