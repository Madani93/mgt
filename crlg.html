<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cari Kata di Repository GitHub</title>
  <script>
    async function searchInRepo() {
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token'); // Mendapatkan token dari URL
      const searchWord = urlParams.get('q'); // Mendapatkan kata pencarian dari URL (diganti menjadi 'q')
      const owner = 'Madani93'; // Owner repository sru1
      const repo = 'sru1'; // Nama repository sru1
      const targetRepo = 'mgt'; // Repository tempat menyimpan crlg1.json
      const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/`;

      if (!token || !searchWord) {
        alert('Token dan kata pencarian (q) harus ada di URL sebagai query parameter.');
        return;
      }

      const result = [];

      try {
        const response = await fetch(apiUrl, {
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });

        if (!response.ok) {
          throw new Error('Gagal mengambil data dari GitHub');
        }

        const files = await response.json();
        
        for (const file of files) {
          if (file.type === 'file') {
            const fileResponse = await fetch(file.download_url);
            const fileContent = await fileResponse.text();

            if (fileContent.includes(searchWord)) {
              result.push({ file: file.path, found: true });
            }
          }
        }

        // Mengubah hasil menjadi JSON
        const jsonResult = JSON.stringify(result, null, 2);

        // Menyimpan JSON ke repository mgt
        await saveResultToRepo(token, jsonResult, targetRepo);

      } catch (error) {
        console.error('Error:', error);
        alert('Terjadi kesalahan saat mencari.');
      }
    }

    async function saveResultToRepo(token, jsonContent, repo) {
      const apiUrl = `https://api.github.com/repos/Madani93/${repo}/contents/crlg1.json`;
      const message = 'Menambahkan hasil pencarian';

      try {
        // Mengecek apakah file crlg1.json sudah ada
        const getFileResponse = await fetch(apiUrl, {
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });

        let contentData = {};
        if (getFileResponse.ok) {
          contentData = await getFileResponse.json();
        }

        // Encode konten dalam base64
        const encodedContent = btoa(jsonContent);

        // Membuat atau mengupdate file crlg1.json
        const method = contentData.sha ? 'PUT' : 'PUT'; // PUT untuk update atau buat baru
        const body = JSON.stringify({
          message: message,
          content: encodedContent,
          sha: contentData.sha || null
        });

        const saveResponse = await fetch(apiUrl, {
          method: method,
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: body
        });

        if (saveResponse.ok) {
          alert('Hasil pencarian telah disimpan ke crlg1.json di repo mgt');
          // Mengalihkan ke path file crlg1.json setelah berhasil menyimpan
          window.location.href = `https://github.com/Madani93/${repo}/blob/main/crlg1.json`;
        } else {
          throw new Error('Gagal menyimpan file ke repository');
        }

      } catch (error) {
        console.error('Error saving to GitHub:', error);
        alert('Gagal menyimpan hasil pencarian ke repository.');
      }
    }
  </script>
</head>
<body>
  <button onclick="searchInRepo()">Cari Kata</button>
</body>
</html>
