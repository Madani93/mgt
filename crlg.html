<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cari Kata di Repository GitHub</title>
  <script>
    window.onload = async function() {
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token'); // Mengambil token dari URL
      const searchWord = urlParams.get('q'); // Mengambil kata pencarian dari URL (diganti menjadi 'q')
      const owner = 'Madani93'; // Owner repository sru1
      const repo = 'sru1'; // Nama repository sru1
      const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/`;

      // Jika token atau kata pencarian tidak ada di URL, tampilkan peringatan
      if (!token || !searchWord) {
        alert('Token dan kata pencarian (q) harus ada di URL sebagai query parameter.');
        return;
      }

      const result = [];

      try {
        // Fetch data from GitHub repository
        const response = await fetch(apiUrl, {
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });

        console.log('GitHub API Response:', response);

        if (!response.ok) {
          throw new Error('Gagal mengambil data dari GitHub. Status: ' + response.status);
        }

        const files = await response.json();
        console.log('Files in Repo:', files);

        // Periksa setiap file dalam repository
        for (const file of files) {
          if (file.type === 'file' && file.name !== 'index') {
            const fileResponse = await fetch(file.download_url);
            const fileContent = await fileResponse.json(); // Parsing isi file sebagai JSON
            console.log('File content:', fileContent);

            // Cari kata pencarian dalam setiap objek JSON
            const searchResult = searchInJson(fileContent, searchWord);

            // Jika ditemukan, simpan hasilnya
            if (searchResult) {
              result.push({
                file: file.path,
                found: searchResult
              });
            }
          }
        }

        // Menampilkan hasil pencarian langsung di halaman
        const resultContainer = document.getElementById('result');
        if (result.length > 0) {
          resultContainer.textContent = JSON.stringify(result, null, 2);
        } else {
          resultContainer.textContent = 'Tidak ditemukan hasil untuk pencarian: "' + searchWord + '"';
        }

      } catch (error) {
        console.error('Error:', error);
        alert('Terjadi kesalahan saat mencari: ' + error.message);
      }
    }

    // Fungsi untuk mencari kata dalam objek JSON
    function searchInJson(obj, searchWord) {
      let result = [];

      // Cek apakah obj adalah objek atau array
      if (typeof obj === 'object') {
        for (let key in obj) {
          if (obj.hasOwnProperty(key)) {
            const value = obj[key];
            if (typeof value === 'string' && value.includes(searchWord)) {
              // Menyimpan kolom yang mengandung kata pencarian
              result.push({ [key]: value });
            } else if (typeof value === 'object') {
              // Rekursif mencari dalam objek yang lebih dalam
              const nestedResult = searchInJson(value, searchWord);
              if (nestedResult && nestedResult.length > 0) {
                result.push({ [key]: nestedResult });
              }
            }
          }
        }
      }

      return result.length > 0 ? result : null;
    }
  </script>
</head>
<body>
  <h2>Hasil Pencarian:</h2>
  <pre id="result"></pre>
</body>
</html>
