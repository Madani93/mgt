<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GitHub JSON Search</title>
</head>
<body>
  <script>
    async function searchGitHubRepo() {
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get("token");
      const query = urlParams.get("q");

      if (!token || !query) {
        document.body.textContent = "Token dan query harus dimasukkan melalui URL.";
        return;
      }

      const repoOwner = "Madani93";
      const repoName = "sru1";

      try {
        // Ambil daftar file di repo
        const response = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents`, {
          headers: { Authorization: `token ${token}` }
        });

        if (!response.ok) {
          throw new Error(`Gagal mengambil daftar file: ${response.statusText}`);
        }

        const files = await response.json();
        const result = [];

        for (const file of files) {
          if (file.name === "index" || !file.name.endsWith(".json")) {
            continue; // Skip file yang bukan JSON atau bernama 'index'
          }

          // Ambil isi file JSON
          const fileResponse = await fetch(file.download_url, {
            headers: { Authorization: `token ${token}` }
          });

          if (!fileResponse.ok) {
            console.warn(`Gagal mengambil file: ${file.name}`);
            continue;
          }

          try {
            const fileText = await fileResponse.text();
            const fileContent = JSON.parse(fileText); // Parse JSON
            const foundData = searchInJson(fileContent, query);

            if (foundData.length > 0) {
              result.push({ file: file.name, data: foundData });
            }
          } catch (error) {
            console.warn(`Gagal memproses file JSON: ${file.name}`, error.message);
          }
        }

        // Tampilkan hasil
        document.body.textContent = JSON.stringify(result, null, 2);
      } catch (error) {
        document.body.textContent = `Terjadi kesalahan: ${error.message}`;
      }
    }

    // Fungsi untuk mencari data dalam JSON
    function searchInJson(json, query) {
      const results = [];

      function recursiveSearch(obj) {
        if (typeof obj === "object" && obj !== null) {
          for (const key in obj) {
            if (typeof obj[key] === "string" && obj[key].includes(query)) {
              results.push(obj); // Tambahkan seluruh objek yang mengandung query
              return; // Stop pencarian di objek ini
            } else {
              recursiveSearch(obj[key]); // Rekursi ke dalam
            }
          }
        }
      }

      recursiveSearch(json);
      return results;
    }

    searchGitHubRepo();
  </script>
</body>
</html>
