<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pencarian di GitHub</title>
</head>
<body>
  <script>
    async function searchGitHubRepo() {
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get("token");
      const query = urlParams.get("q");

      if (!token || !query) {
        document.body.textContent = "Token dan query harus dimasukkan melalui URL.";
        return;
      }

      const repoOwner = "Madani93";
      const repoName = "sru1";

      try {
        // Ambil daftar file di repo
        const response = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents`, {
          headers: { Authorization: `token ${token}` }
        });

        if (!response.ok) {
          throw new Error(`Gagal mengambil daftar file: ${response.statusText}`);
        }

        const files = await response.json();
        const result = [];

        for (const file of files) {
          if (file.name === "index") {
            continue; // Skip file bernama 'index'
          }

          // Ambil isi file teks
          const fileResponse = await fetch(file.download_url, {
            headers: { Authorization: `token ${token}` }
          });

          if (!fileResponse.ok) {
            console.warn(`Gagal mengambil file: ${file.name}`);
            continue;
          }

          try {
            const fileText = await fileResponse.text();
            const matchingLines = searchInText(fileText, query);

            if (matchingLines.length > 0) {
              result.push({ file: file.name, lines: matchingLines });
            }
          } catch (error) {
            console.warn(`Gagal memproses file: ${file.name}`, error.message);
          }
        }

        // Tampilkan hasil
        document.body.textContent = JSON.stringify(result, null, 2);
      } catch (error) {
        document.body.textContent = `Terjadi kesalahan: ${error.message}`;
      }
    }

    // Fungsi untuk mencari kata dalam teks
    function searchInText(text, query) {
      const lines = text.split("\n");
      return lines.filter(line => line.includes(query));
    }

    searchGitHubRepo();
  </script>
</body>
</html>
